// ========================================
// ðŸ”¥ FIREBASE FIRESTORE RULES
// ========================================
// ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // Ð’Ð¡ÐŸÐžÐœÐžÐ“ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜
    // ========================================
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð¾Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    function isModerator() {
      return isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'moderator');
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: users
    // ========================================
    match /users/{userId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
      allow read: if isSignedIn();
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÐµÐ±Ñ
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¸Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½
      allow update: if isOwner(userId) || isAdmin();
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½
      allow delete: if isAdmin();
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: content (Ð°Ð½Ð¸Ð¼Ðµ/ÑÐµÑ€Ð¸Ð°Ð»Ñ‹)
    // ========================================
    match /content/{contentId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ (Ð´Ð°Ð¶Ðµ Ð½ÐµÐ°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº)
      allow read: if true;
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ, ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ñ‹ Ð¸ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹
      allow create: if isModerator();
      allow update: if isModerator();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: comments (ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸)
    // ========================================
    match /comments/{commentId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
      allow read: if isSignedIn();
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
      allow create: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.username is string
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 500;
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†, Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¸Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½
      allow delete: if isOwner(resource.data.userId) || isModerator();
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ (ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ð½Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ)
      allow update: if false;
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: ratings (Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¸)
    // ========================================
    match /ratings/{ratingId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
      allow read: if isSignedIn();
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÐ²Ð¾Ð¸Ñ… Ð¾Ñ†ÐµÐ½Ð¾Ðº
      allow create, update: if isSignedIn() 
        && ratingId == request.auth.uid + '_' + request.resource.data.animeId
        && request.resource.data.stars >= 1 
        && request.resource.data.stars <= 5;
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¸Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: video_reactions (Ð»Ð°Ð¹ÐºÐ¸/Ð´Ð¸Ð·Ð»Ð°Ð¹ÐºÐ¸)
    // ========================================
    match /video_reactions/{reactionId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
      allow read: if isSignedIn();
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÐ²Ð¾Ð¸Ñ… Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¹
      allow create, update: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.type in ['like', 'dislike'];
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¸Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: friends (Ð´Ñ€ÑƒÐ·ÑŒÑ)
    // ========================================
    match /friends/{friendId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
      allow read: if isSignedIn();
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÐµÐ±Ñ
      allow create: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid;
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
      allow delete: if isOwner(resource.data.userId);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ
      allow update: if false;
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: friend_requests (Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð² Ð´Ñ€ÑƒÐ·ÑŒÑ)
    // ========================================
    match /friend_requests/{requestId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
      allow read: if isSignedIn() 
        && (request.auth.uid == resource.data.from 
        || request.auth.uid == resource.data.to);
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
      allow create: if isSignedIn() 
        && request.resource.data.from == request.auth.uid
        && request.resource.data.from != request.resource.data.to;
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
      allow delete: if isSignedIn() 
        && (request.auth.uid == resource.data.from 
        || request.auth.uid == resource.data.to);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ
      allow update: if false;
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: messages (Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ)
    // ========================================
    match /messages/{messageId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸ Ð±ÐµÑÐµÐ´Ñ‹
      allow read: if isSignedIn() 
        && (request.auth.uid == resource.data.from 
        || request.auth.uid == resource.data.to);
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
      allow create: if isSignedIn() 
        && request.resource.data.from == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 1000;
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ Ð¸Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½
      allow delete: if isOwner(resource.data.from) || isAdmin();
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ
      allow update: if false;
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: notifications (ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ)
    // ========================================
    match /notifications/{notificationId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
      allow read: if isSignedIn() && isOwner(resource.data.userId);
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð»ÑŽÐ±Ð¾Ð¹ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹
      allow create: if isSignedIn();
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† (Ð´Ð»Ñ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ð¼)
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // ========================================
    // ÐšÐžÐ›Ð›Ð•ÐšÐ¦Ð˜Ð¯: watch_history (Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¾Ð²)
    // ========================================
    match /watch_history/{historyId} {
      // Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
      allow read: if isSignedIn() && isOwner(resource.data.userId);
      
      // Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
      allow create, update: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid;
      
      // Ð£Ð´Ð°Ð»ÑÑ‚ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }
    
    // ========================================
    // Ð—ÐÐŸÐ Ð•Ð¢Ð˜Ð¢Ð¬ Ð’Ð¡Ð• ÐžÐ¡Ð¢ÐÐ›Ð¬ÐÐžÐ•
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
