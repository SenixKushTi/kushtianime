// ========================================
// üî• FIREBASE STORAGE RULES
// ========================================
// –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Ñ–∞–π–ª–æ–≤

rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ========================================
    // –ü–ê–ü–ö–ê: avatars (–∞–≤–∞—Ç–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    // ========================================
    match /avatars/{userId}/{fileName} {
      // –ß–∏—Ç–∞—Ç—å –º–æ–≥—É—Ç –≤—Å–µ
      allow read: if true;
      
      // –ó–∞–≥—Ä—É–∂–∞—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.size < 5 * 1024 * 1024  // –ú–∞–∫—Å–∏–º—É–º 5MB
        && request.resource.contentType.matches('image/.*');  // –¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    }
    
    // ========================================
    // –ü–ê–ü–ö–ê: posters (–ø–æ—Å—Ç–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
    // ========================================
    match /posters/{fileName} {
      // –ß–∏—Ç–∞—Ç—å –º–æ–≥—É—Ç –≤—Å–µ
      allow read: if true;
      
      // –ó–∞–≥—Ä—É–∂–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã
      allow write: if request.auth != null
        && (getUserRole() == 'admin' || getUserRole() == 'moderator')
        && request.resource.size < 10 * 1024 * 1024  // –ú–∞–∫—Å–∏–º—É–º 10MB
        && request.resource.contentType.matches('image/.*');
    }
    
    // ========================================
    // –ü–ê–ü–ö–ê: backgrounds (—Ñ–æ–Ω—ã)
    // ========================================
    match /backgrounds/{fileName} {
      // –ß–∏—Ç–∞—Ç—å –º–æ–≥—É—Ç –≤—Å–µ
      allow read: if true;
      
      // –ó–∞–≥—Ä—É–∂–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã
      allow write: if request.auth != null
        && getUserRole() == 'admin'
        && request.resource.size < 10 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
    }
    
    // ========================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ========================================
    function getUserRole() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // ========================================
    // –ó–ê–ü–†–ï–¢–ò–¢–¨ –í–°–ï –û–°–¢–ê–õ–¨–ù–û–ï
    // ========================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
