<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kushti ‚Äì –û–Ω–ª–∞–π–Ω –∫–∏–Ω–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –¢–ï–ú */
        :root {
            --bg-primary: #18181b;
            --bg-secondary: #27272a;
            --bg-card: #18181b;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #3f3f46;
            --accent-color: #ea580c;
        }

        body.light-mode {
            --bg-primary: #f4f4f5;
            --bg-secondary: #e4e4e7;
            --bg-card: #ffffff;
            --text-primary: #18181b;
            --text-secondary: #52525b;
            --border-color: #d4d4d8;
            --accent-color: #ea580c;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .bg-custom-card {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }

        .text-custom-primary {
            color: var(--text-primary);
        }

        .text-custom-secondary {
            color: var(--text-secondary);
        }

        .border-custom {
            border-color: var(--border-color);
        }

        nav {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ea580c;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.hide {
            animation: slideOut 0.3s ease forwards;
        }
        
        @keyframes slideOut {
            to { transform: translateX(400px); opacity: 0; }
        }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .category-btn, .genre-btn {
            transition: all 0.2s ease;
            background-color: var(--bg-card);
            color: var(--text-primary);
        }
        
        .category-btn:hover, .genre-btn:hover {
            transform: translateY(-2px);
        }
        
        .category-btn.active {
            background: #ea580c !important;
            color: white !important;
        }
        
        .genre-btn.active {
            background: #ea580c !important;
            color: white !important;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-bg {
            background-color: var(--bg-card);
        }

        input, select {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        input:focus, select:focus {
            border-color: #ea580c !important;
        }

        /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
        .comment-card {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }

        .search-input {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="offline-banner" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-2 text-sm z-50">
        <i class="fas fa-wifi-slash mr-2"></i>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã –∂–æ“õ
    </div>

    <nav class="p-4 border-b sticky top-0 z-40 flex justify-between items-center backdrop-blur-lg">
        <div class="flex items-center gap-3">
            <img src="https://lh3.googleusercontent.com/u/0/d/15Rj9MeJhiBZzk7UZZ3uWYvng3lPQmbo-=w1000" 
                 onclick="location.href='index.html'" 
                 class="h-8 w-auto cursor-pointer object-contain" 
                 alt="Kushti Logo">
            <h1 class="text-2xl md:text-3xl font-black text-custom-primary italic uppercase">Kushti</h1>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="toggleTheme()" class="text-xl text-custom-primary">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
            <button onclick="location.href='chat.html'" class="text-xl text-custom-primary">
                <i class="fas fa-comments"></i>
            </button>
            <button id="admin-btn" onclick="location.href='admin.html'" class="hidden text-xl text-orange-500" title="–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å">
                <i class="fas fa-shield-alt"></i>
            </button>
            <div id="auth-ui">
                <button onclick="openM()" class="bg-orange-600 px-4 py-2 rounded-xl font-bold text-sm text-white">–ö–Ü–†–£</button>
            </div>
            <div id="user-ui" class="hidden flex items-center gap-3">
                <span id="u-name" onclick="location.href='profile.html'" class="text-orange-400 font-bold cursor-pointer text-sm underline"></span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="mb-6">
            <div class="relative">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="üîç –Ü–∑–¥–µ—É (–∞—Ç–∞—É—ã –±–æ–π—ã–Ω—à–∞)..." 
                    class="search-input w-full p-4 rounded-xl border outline-none focus:border-orange-500 text-sm"
                    oninput="searchContent()"
                >
            </div>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="mb-6">
            <h2 class="text-custom-primary font-bold mb-3 text-lg">–ö–∞—Ç–µ–≥–æ—Ä–∏—è–ª–∞—Ä</h2>
            <div class="flex gap-3 flex-wrap">
                <button onclick="filterByCategory('all')" class="category-btn active px-6 py-3 rounded-xl font-bold text-sm border">
                    –ë–∞—Ä–ª—ã“ì—ã
                </button>
                <button onclick="filterByCategory('anime')" class="category-btn px-6 py-3 rounded-xl font-bold text-sm border">
                    üéå –ê–Ω–∏–º–µ
                </button>
                <button onclick="filterByCategory('series')" class="category-btn px-6 py-3 rounded-xl font-bold text-sm border">
                    üì∫ –°–µ—Ä–∏–∞–ª–¥–∞—Ä
                </button>
                <button onclick="filterByCategory('dorama')" class="category-btn px-6 py-3 rounded-xl font-bold text-sm border">
                    üé≠ –î–æ—Ä–∞–º–∞
                </button>
            </div>
        </div>

        <!-- –ñ–∞–Ω—Ä—ã -->
        <div class="mb-6">
            <h2 class="text-custom-primary font-bold mb-3 text-lg">–ñ–∞–Ω—Ä–ª–∞—Ä</h2>
            <div class="flex gap-2 flex-wrap">
                <button onclick="filterByGenre('all')" class="genre-btn active px-4 py-2 rounded-lg text-xs font-bold border">
                    –ë–∞—Ä–ª—ã“ì—ã
                </button>
                <button onclick="filterByGenre('action')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    –≠–∫—à–Ω
                </button>
                <button onclick="filterByGenre('comedy')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    –ö–æ–º–µ–¥–∏—è
                </button>
                <button onclick="filterByGenre('drama')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    –î—Ä–∞–º–∞
                </button>
                <button onclick="filterByGenre('romance')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    –†–æ–º–∞–Ω—Ç–∏–∫–∞
                </button>
                <button onclick="filterByGenre('fantasy')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    –§—ç–Ω—Ç–µ–∑–∏
                </button>
                <button onclick="filterByGenre('horror')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    “ö–æ—Ä“õ—ã–Ω—ã—à—Ç—ã
                </button>
                <button onclick="filterByGenre('thriller')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    –¢—Ä–∏–ª–ª–µ—Ä
                </button>
                <button onclick="filterByGenre('scifi')" class="genre-btn px-4 py-2 rounded-lg text-xs font-bold border">
                    “í—ã–ª—ã–º–∏ —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞
                </button>
            </div>
        </div>

        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-custom-primary font-bold text-lg">–ö–æ–Ω—Ç–µ–Ω—Ç</h2>
            <select id="sort-select" onchange="sortContent()" class="px-4 py-2 rounded-xl border text-sm font-bold">
                <option value="newest">–ñ–∞“£–∞–¥–∞–Ω –µ—Å–∫—ñ–≥–µ</option>
                <option value="rating">–†–µ–π—Ç–∏–Ω–≥ –±–æ–π—ã–Ω—à–∞</option>
                <option value="views">–ö”©—Ä—ñ–ª—ñ–º–¥–µ—Ä –±–æ–π—ã–Ω—à–∞</option>
                <option value="title">–ê—Ç–∞—É—ã –±–æ–π—ã–Ω—à–∞</option>
            </select>
        </div>

        <div id="loading" class="loader"></div>
        <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 md:gap-6 hidden"></div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-m" class="hidden fixed inset-0 bg-black/90 flex justify-center items-center z-[100] p-4">
        <div class="modal-bg p-6 rounded-3xl w-full max-w-sm border border-custom">
            <h2 id="m-t" class="text-xl font-bold mb-6 text-orange-500 text-center uppercase">–ö—ñ—Ä—É</h2>
            <div id="reg-fields" class="hidden">
                <input type="text" id="m-un" placeholder="–ù–∏–∫–Ω–µ–π–º" class="w-full p-4 rounded-xl mb-3 outline-none border">
                <p class="text-[10px] mb-3 opacity-60 text-custom-secondary">–ù–∏–∫–Ω–µ–π–º: 3-20 —Å–∏–º–≤–æ–ª, —Ç–µ–∫ ”ô—Ä—ñ–ø—Ç–µ—Ä/—Å–∞–Ω–¥–∞—Ä</p>
            </div>
            <input type="email" id="m-e" placeholder="Email" class="w-full p-4 rounded-xl mb-3 outline-none border">
            <input type="password" id="m-p" placeholder="“ö“±–ø–∏—è —Å”©–∑ (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª)" class="w-full p-4 rounded-xl mb-6 outline-none border">
            <button onclick="authAcc()" id="m-b" class="w-full bg-orange-600 py-4 rounded-xl font-black uppercase tracking-widest text-white">–†–∞—Å—Ç–∞—É</button>
            <p id="m-sw" class="text-center mt-4 text-xs text-custom-secondary cursor-pointer underline" onclick="switchM()">–¢—ñ—Ä–∫–µ–ª—É</p>
            <p class="text-center mt-3 text-xs text-custom-secondary cursor-pointer underline" onclick="closeM()">–ñ–∞–±—É</p>
        </div>
    </div>

    <!-- Firebase SDK v11 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc,
            getDocs,
            onSnapshot,
            query,
            where,
            orderBy,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyB3Tf0kqjLPinrVrcxzB_0Niy3RIL9FJ5Q",
            authDomain: "kushti-anime.firebaseapp.com",
            projectId: "kushti-anime",
            storageBucket: "kushti-anime.firebasestorage.app",
            messagingSenderId: "539636802828",
            appId: "1:539636802828:web:9d6d7877d88ac452d61529",
            measurementId: "G-7ZTFL5TVCS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let allContent = [];
        let currentCategory = 'all';
        let currentGenre = 'all';
        let currentSort = 'newest';
        let searchQuery = '';

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        window.toggleTheme = () => {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-mode');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –Ω–æ–≤–æ–π —Ç–µ–º–æ–π
            renderContent();
        };

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const icon = document.getElementById('theme-icon');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        });

        // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        window.showToast = (msg, type = 'success') => {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${msg}`;
            document.body.appendChild(t);
            setTimeout(() => {
                t.classList.add('hide');
                setTimeout(() => t.remove(), 300);
            }, 3000);
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let isReg = false;
        
        window.openM = () => {
            document.getElementById('auth-m').classList.remove('hidden');
        };
        
        window.closeM = () => {
            document.getElementById('auth-m').classList.add('hidden');
        };
        
        window.switchM = () => {
            isReg = !isReg;
            document.getElementById('m-t').innerText = isReg ? '–¢—ñ—Ä–∫–µ–ª—É' : '–ö—ñ—Ä—É';
            document.getElementById('m-b').innerText = isReg ? '–¢—ñ—Ä–∫–µ–ª—É' : '–ö—ñ—Ä—É';
            document.getElementById('m-sw').innerText = isReg ? '–ö—ñ—Ä—É' : '–¢—ñ—Ä–∫–µ–ª—É';
            document.getElementById('reg-fields').classList.toggle('hidden', !isReg);
        };

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∏–∫–Ω–µ–π–º–∞
        const validateUsername = (username) => {
            if (!username || username.trim() === '') {
                return { valid: false, error: '–ù–∏–∫–Ω–µ–π–º –±–æ—Å –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫!' };
            }
            
            const trimmed = username.trim().toLowerCase();
            
            if (trimmed.length < 3) {
                return { valid: false, error: '–ù–∏–∫–Ω–µ–π–º –∫–µ–º—ñ–Ω–¥–µ 3 —Å–∏–º–≤–æ–ª–¥–∞–Ω —Ç“±—Ä—É—ã –∫–µ—Ä–µ–∫!' };
            }
            
            if (trimmed.length > 20) {
                return { valid: false, error: '–ù–∏–∫–Ω–µ–π–º 20 —Å–∏–º–≤–æ–ª–¥–∞–Ω –∞—Å–ø–∞—É—ã –∫–µ—Ä–µ–∫!' };
            }
            
            if (!/^[a-z0-9_]+$/.test(trimmed)) {
                return { valid: false, error: '–ù–∏–∫–Ω–µ–π–º–¥–µ —Ç–µ–∫ ”ô—Ä—ñ–ø—Ç–µ—Ä, —Å–∞–Ω–¥–∞—Ä –∂”ô–Ω–µ _ –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω!' };
            }
            
            return { valid: true, username: trimmed };
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º–∞
        const isUsernameUnique = async (username) => {
            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                return snapshot.empty;
            } catch (error) {
                console.error('Username check error:', error);
                return false;
            }
        };

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        window.authAcc = async () => {
            const e = document.getElementById('m-e').value.trim();
            const p = document.getElementById('m-p').value;
            
            if (!e || !p) {
                showToast('–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!', 'error');
                return;
            }

            try {
                if (isReg) {
                    const un = document.getElementById('m-un').value;
                    const validation = validateUsername(un);
                    
                    if (!validation.valid) {
                        showToast(validation.error, 'error');
                        return;
                    }

                    // ‚ö†Ô∏è –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û - –ø—Ä–æ–≤–µ—Ä–∫–∞ username (–Ω—É–∂–µ–Ω –∏–Ω–¥–µ–∫—Å –≤ Firestore)
                    // const isUnique = await isUsernameUnique(validation.username);
                    // if (!isUnique) {
                    //     showToast('–ë“±–ª –Ω–∏–∫–Ω–µ–π–º “õ–æ–ª–¥–∞–Ω—ã—Å—Ç–∞. –ë–∞—Å“õ–∞—Å—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑!', 'error');
                    //     return;
                    // }

                    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const res = await createUserWithEmailAndPassword(auth, e, p);
                    
                    // –ö–†–ò–¢–ò–ß–ù–û: –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ users —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    await setDoc(doc(db, "users", res.user.uid), { 
                        username: validation.username, 
                        email: e, 
                        bio: "Kushti “õ–æ–ª–¥–∞–Ω—É—à—ã—Å—ã",
                        role: "user",
                        createdAt: Date.now()
                    });
                    
                    showToast('–¢—ñ—Ä–∫–µ–ª—É —Å”ô—Ç—Ç—ñ! “ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!', 'success');
                } else { 
                    await signInWithEmailAndPassword(auth, e, p);
                    showToast('–ö—ñ—Ä—É —Å”ô—Ç—Ç—ñ!', 'success');
                }
                closeM();
            } catch(err) { 
                console.error('Auth error:', err);
                const errors = {
                    'auth/email-already-in-use': '–ë“±–ª email “õ–æ–ª–¥–∞–Ω—ã—Å—Ç–∞!',
                    'auth/invalid-email': 'Email —Ñ–æ—Ä–º–∞—Ç—ã –¥“±—Ä—ã—Å –µ–º–µ—Å!',
                    'auth/weak-password': '“ö“±–ø–∏—è —Å”©–∑ ”©—Ç–µ ”ô–ª—Å—ñ–∑ (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª)!',
                    'auth/user-not-found': 'Email –Ω–µ–º–µ—Å–µ “õ“±–ø–∏—è —Å”©–∑ –¥“±—Ä—ã—Å –µ–º–µ—Å!',
                    'auth/wrong-password': 'Email –Ω–µ–º–µ—Å–µ “õ“±–ø–∏—è —Å”©–∑ –¥“±—Ä—ã—Å –µ–º–µ—Å!',
                    'auth/invalid-credential': 'Email –Ω–µ–º–µ—Å–µ “õ“±–ø–∏—è —Å”©–∑ –¥“±—Ä—ã—Å –µ–º–µ—Å!'
                };
                showToast(errors[err.code] || '“ö–∞—Ç–µ: ' + err.message, 'error');
            }
        };

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        onAuthStateChanged(auth, async u => {
            document.getElementById('auth-ui').classList.toggle('hidden', !!u);
            document.getElementById('user-ui').classList.toggle('hidden', !u);
            
            if(u) {
                try {
                    const userDoc = await getDoc(doc(db, "users", u.uid));
                    if(userDoc.exists()) {
                        const userData = userDoc.data();
                        document.getElementById('u-name').innerText = "@" + userData.username;
                        
                        const role = userData.role || 'user';
                        if(role === 'admin' || role === 'moderator') {
                            document.getElementById('admin-btn').classList.remove('hidden');
                        }
                    } else {
                        document.getElementById('u-name').innerText = "–ü—Ä–æ—Ñ–∏–ª—å";
                    }
                } catch(e) {
                    console.error('User load error:', e);
                }
            }
        });

        // –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        window.searchContent = () => {
            searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
            renderContent();
        };

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        window.filterByCategory = (category) => {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderContent();
        };

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∂–∞–Ω—Ä–∞–º
        window.filterByGenre = (genre) => {
            currentGenre = genre;
            document.querySelectorAll('.genre-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderContent();
        };

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        window.sortContent = () => {
            currentSort = document.getElementById('sort-select').value;
            renderContent();
        };

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        function renderContent() {
            let filtered = [...allContent];

            // –ü–æ–∏—Å–∫
            if (searchQuery) {
                filtered = filtered.filter(item => {
                    const title = (item.title_kz || '').toLowerCase();
                    const titleRu = (item.title_ru || '').toLowerCase();
                    return title.includes(searchQuery) || titleRu.includes(searchQuery);
                });
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (currentCategory !== 'all') {
                filtered = filtered.filter(item => item.category === currentCategory);
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∂–∞–Ω—Ä—É
            if (currentGenre !== 'all') {
                filtered = filtered.filter(item => 
                    item.genres && item.genres.includes(currentGenre)
                );
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            switch(currentSort) {
                case 'rating':
                    filtered.sort((a, b) => (b.avgRating || 0) - (a.avgRating || 0));
                    break;
                case 'views':
                    filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
                    break;
                case 'title':
                    filtered.sort((a, b) => (a.title_kz || '').localeCompare(b.title_kz || ''));
                    break;
                case 'newest':
                default:
                    filtered.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    break;
            }

            const g = document.getElementById('grid');
            g.innerHTML = '';
            
            if (filtered.length === 0) {
                g.innerHTML = `<p class="col-span-full text-center opacity-60 text-custom-primary py-8">
                    ${searchQuery ? '–Ü–∑–¥–µ—É –±–æ–π—ã–Ω—à–∞ –µ—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã' : '–ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±—ã–ª–º–∞–¥—ã'}
                </p>`;
                return;
            }

            filtered.forEach(item => {
                const categoryIcon = item.category === 'anime' ? 'üéå' : 
                                   item.category === 'series' ? 'üì∫' : 'üé≠';
                
                const card = document.createElement('div');
                card.onclick = () => location.href = `details.html?id=${item.id}`;
                card.className = 'bg-custom-card rounded-2xl overflow-hidden border border-custom hover:border-orange-500 transition shadow-lg cursor-pointer';
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${item.poster_url}" class="w-full aspect-[2/3] object-cover" alt="${item.title_kz || '–ö–æ–Ω—Ç–µ–Ω—Ç'}">
                        <div class="absolute top-2 left-2 bg-black/80 px-2 py-1 rounded-lg text-xs text-white">${categoryIcon}</div>
                        <div class="absolute top-2 right-2 bg-black/80 px-2 py-1 rounded-lg text-xs text-white">‚≠ê ${(item.avgRating || 0).toFixed(1)}</div>
                    </div>
                    <div class="p-3">
                        <div class="text-xs font-bold truncate text-custom-primary mb-1">${item.title_kz || '–ê—Ç–∞—É—ã –∂–æ“õ'}</div>
                        <div class="text-[10px] opacity-60 text-custom-secondary">üëÅ ${item.views || 0} –∫”©—Ä—ñ–ª—ñ–º</div>
                    </div>
                `;
                
                g.appendChild(card);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ Firestore
        onSnapshot(collection(db, "content"), snapshot => {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('grid'); 
            
            loading.classList.add('hidden');
            grid.classList.remove('hidden');
            
            allContent = [];
            snapshot.forEach(doc => {
                allContent.push({ id: doc.id, ...doc.data() });
            });

            renderContent();
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        window.addEventListener('online', () => {
            document.getElementById('offline-banner').classList.add('hidden');
            showToast('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª–¥—ñ!', 'success');
        });

        window.addEventListener('offline', () => {
            document.getElementById('offline-banner').classList.remove('hidden');
        });
    </script>
</body>
</html>
