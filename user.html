<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äì Kushti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .toast { position: fixed; top: 20px; right: 20px; background: #ea580c; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.hide { animation: slideOut 0.3s ease forwards; }
        @keyframes slideOut { to { transform: translateX(400px); opacity: 0; } }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #ea580c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-container { text-align: center; padding: 60px 20px; }
        .error-icon { font-size: 64px; color: #ea580c; margin-bottom: 20px; }
    </style>
</head>
<body class="min-h-screen bg-black text-white transition-colors duration-300">
    <div id="offline-banner" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-2 text-sm z-50">
        <i class="fas fa-wifi-slash mr-2"></i>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã –∂–æ“õ
    </div>

    <nav class="p-4 border-b border-zinc-800 flex justify-between items-center sticky top-0 z-50 bg-zinc-900 backdrop-blur-lg">
        <button onclick="history.back()" class="text-orange-500 font-bold">‚Üê –ê–†–¢“ö–ê</button>
        <span class="font-black italic text-orange-500">Kushti</span>
        <div class="flex gap-3 items-center">
            <button id="admin-btn" onclick="location.href='admin.html'" class="hidden text-orange-500" title="–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å"><i class="fas fa-shield-alt"></i></button>
            <button onclick="toggleTheme()"><i id="theme-icon" class="fas fa-moon text-white"></i></button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-6">
        <!-- Loader -->
        <div id="loading">
            <div class="loader"></div>
            <p class="text-center text-sm opacity-70 mt-4">–ü—Ä–æ—Ñ–∏–ª—å –∂“Ø–∫—Ç–µ–ª—É–¥–µ...</p>
        </div>
        
        <!-- Error Container -->
        <div id="error-container" class="hidden error-container">
            <i class="fas fa-user-slash error-icon"></i>
            <h2 class="text-2xl font-bold text-orange-500 mb-4">–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã</h2>
            <p class="text-sm opacity-70 mb-2" id="error-message">–ë“±–ª –ø—Ä–æ—Ñ–∏–ª—å –∂–æ“õ –Ω–µ–º–µ—Å–µ –∂–æ–π—ã–ª“ì–∞–Ω</p>
            <p class="text-xs opacity-50 mb-6" id="error-details"></p>
            <button onclick="location.href='index.html'" class="bg-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-700 text-white">
                –ë–∞—Å—Ç—ã –±–µ—Ç–∫–µ –æ—Ä–∞–ª—É
            </button>
        </div>
        
        <!-- Profile Content -->
        <div id="profile-content" class="hidden">
            <div class="rounded-[40px] p-8 border border-zinc-800 mb-6">
                <div class="flex flex-col md:flex-row gap-6 items-center md:items-start">
                    <div id="user-avatar-container" class="w-32 h-32 bg-gradient-to-br from-orange-600 to-orange-800 rounded-full flex items-center justify-center text-5xl font-black text-white">
                        <span id="user-avatar">U</span>
                    </div>
                    
                    <div class="flex-1 text-center md:text-left">
                        <h1 id="user-name" class="text-3xl font-black text-orange-500 mb-2">@username</h1>
                        <div class="flex gap-4 justify-center md:justify-start mb-4 text-sm opacity-70">
                            <div>
                                <span id="friends-count" class="font-bold text-orange-500">0</span>
                                <span class="ml-1">–¥–æ—Å—Ç–∞—Ä</span>
                            </div>
                            <div id="online-status" class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                                <span>–û—Ñ–ª–∞–π–Ω</span>
                            </div>
                        </div>
                        <p id="user-bio" class="opacity-70 mb-6 max-w-md">–ë–∏–æ –∂–æ“õ</p>
                        
                        <div id="action-buttons" class="flex flex-wrap gap-3 justify-center md:justify-start">
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="p-6 rounded-2xl border border-zinc-800 text-center">
                    <div class="text-3xl font-black text-orange-500 mb-2" id="comments-count">0</div>
                    <div class="text-sm opacity-70">–ü—ñ–∫—ñ—Ä–ª–µ—Ä</div>
                </div>
                <div class="p-6 rounded-2xl border border-zinc-800 text-center">
                    <div class="text-3xl font-black text-orange-500 mb-2" id="ratings-count">0</div>
                    <div class="text-sm opacity-70">–ë–∞“ì–∞–ª–∞—Ä</div>
                </div>
                <div class="p-6 rounded-2xl border border-zinc-800 text-center">
                    <div class="text-3xl font-black text-orange-500 mb-2" id="avg-rating">0.0</div>
                    <div class="text-sm opacity-70">–û—Ä—Ç–∞—à–∞ –±–∞“ì–∞</div>
                </div>
            </div>

            <div class="mb-6 p-6 rounded-3xl border border-zinc-800">
                <h2 class="text-xl font-bold text-orange-500 mb-4">–ö–æ–ª–ª–µ–∫—Ü–∏—è–ª–∞—Ä</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="p-4 rounded-xl border border-zinc-800 text-center">
                        <i class="fas fa-play-circle text-2xl text-orange-500 mb-2"></i>
                        <p class="text-xs font-bold">“ö–∞—Ä–∞–ø –∂–∞—Ç—ã—Ä</p>
                        <p id="count-watching" class="text-xl font-black text-orange-500">0</p>
                    </div>
                    <div class="p-4 rounded-xl border border-zinc-800 text-center">
                        <i class="fas fa-heart text-2xl text-red-500 mb-2"></i>
                        <p class="text-xs font-bold">–°“Ø–π—ñ–∫—Ç—ñ–ª–µ—Ä</p>
                        <p id="count-favorite" class="text-xl font-black text-red-500">0</p>
                    </div>
                    <div class="p-4 rounded-xl border border-zinc-800 text-center">
                        <i class="fas fa-check-circle text-2xl text-green-500 mb-2"></i>
                        <p class="text-xs font-bold">–ö”©—Ä–¥—ñ</p>
                        <p id="count-completed" class="text-xl font-black text-green-500">0</p>
                    </div>
                    <div class="p-4 rounded-xl border border-zinc-800 text-center">
                        <i class="fas fa-clock text-2xl text-blue-500 mb-2"></i>
                        <p class="text-xs font-bold">–ñ–æ—Å–ø–∞—Ä–¥–∞</p>
                        <p id="count-planned" class="text-xl font-black text-blue-500">0</p>
                    </div>
                </div>
            </div>

            <div class="rounded-2xl p-6 border border-zinc-800 mb-6">
                <h2 class="text-xl font-bold text-orange-500 mb-4">–ë–∞“ì–∞–ª–∞—Ä—ã</h2>
                <div id="user-ratings" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>

            <div class="rounded-2xl p-6 border border-zinc-800">
                <h2 class="text-xl font-bold text-orange-500 mb-4">–°–æ“£“ì—ã –ø—ñ–∫—ñ—Ä–ª–µ—Ä</h2>
                <div id="recent-comments" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB3Tf0kqjLPinrVrcxzB_0Niy3RIL9FJ5Q", 
            authDomain: "kushti-anime.firebaseapp.com", 
            projectId: "kushti-anime", 
            storageBucket: "kushti-anime.firebasestorage.app", 
            messagingSenderId: "539636802828", 
            appId: "1:539636802828:web:9d6d7877d88ac452d61529", 
            measurementId: "G-7ZTFL5TVCS" 
        };

        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

        // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');

        console.log('üìç URL:', window.location.href);
        console.log('üìç Requested userId:', userId);

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#dc2626' : '#ea580c';
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => { 
                toast.classList.add('hide'); 
                setTimeout(() => toast.remove(), 300); 
            }, 3000);
        }

        window.addEventListener('online', () => { 
            document.getElementById('offline-banner').classList.add('hidden'); 
            showToast('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç “õ–æ—Å—ã–ª–¥—ã', 'success'); 
        });
        
        window.addEventListener('offline', () => { 
            document.getElementById('offline-banner').classList.remove('hidden'); 
        });

        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            const nav = document.querySelector('nav');
            
            if (theme === 'dark') {
                body.className = 'min-h-screen bg-black text-white transition-colors duration-300';
                nav.classList.add('bg-zinc-900', 'border-zinc-800');
                nav.classList.remove('bg-white', 'border-gray-200');
                document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
                document.querySelectorAll('.border').forEach(el => {
                    if (!el.classList.contains('border-orange-500') && !el.classList.contains('border-red-500')) {
                        el.classList.add('border-zinc-800');
                        el.classList.remove('border-gray-200');
                    }
                });
            } else {
                body.className = 'min-h-screen bg-white text-gray-900 transition-colors duration-300';
                nav.classList.add('bg-white', 'border-gray-200');
                nav.classList.remove('bg-zinc-900', 'border-zinc-800');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
                document.querySelectorAll('.border').forEach(el => {
                    if (!el.classList.contains('border-orange-500') && !el.classList.contains('border-red-500')) {
                        el.classList.add('border-gray-200');
                        el.classList.remove('border-zinc-800');
                    }
                });
            }
        }

        window.toggleTheme = () => {
            const current = localStorage.getItem('theme') || 'dark';
            localStorage.setItem('theme', current === 'dark' ? 'light' : 'dark');
            applyTheme();
        };

        applyTheme();

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message = '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã', details = '') {
            console.error('‚ùå –û—à–∏–±–∫–∞:', message, details);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profile-content').classList.add('hidden');
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-details').textContent = details;
        }

        async function loadUserProfile() {
            console.log('üîç –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ—Ñ–∏–ª—è...');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å—Ç—å –ª–∏ userId?
            if (!userId) {
                console.error('‚ùå No userId provided in URL');
                showError('–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã ID –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–≥–µ–Ω!', 'URL –º–µ–∫–µ–Ω–∂–∞–π—ã–Ω–¥–∞ ?uid=... –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ –∂–æ“õ');
                return;
            }

            console.log('‚úÖ userId –Ω–∞–π–¥–µ–Ω:', userId);

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
                console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore...');
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    console.error('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    showError('–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã!', `ID: ${userId} –±–æ–π—ã–Ω—à–∞ –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã –±–∞–∑–∞–¥–∞ –∂–æ“õ`);
                    return;
                }

                const userData = userDoc.data();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', userData);

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                console.log('üìù –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è...');
                document.getElementById('user-name').textContent = '@' + (userData.username || 'User');
                document.getElementById('user-avatar').textContent = (userData.username || 'U')[0].toUpperCase();
                document.getElementById('user-bio').textContent = userData.bio || '–ë–∏–æ –∂–æ“õ';

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                console.log('üìö –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏...');
                await loadCollections(userId);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                console.log('üí¨ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏...');
                await loadComments(userId);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏
                console.log('‚≠ê –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏...');
                await loadRatings(userId);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π
                console.log('üë• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π...');
                await loadFriends(userId);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                console.log('üîò –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π...');
                await loadActionButtons(userId, userData.username);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('profile-content').classList.remove('hidden');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω –∫–Ω–æ–ø–∫–∏
                if (auth.currentUser) {
                    const currentUserDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                    if (currentUserDoc.exists()) {
                        const role = currentUserDoc.data().role;
                        if (role === 'admin' || role === 'moderator') {
                            document.getElementById('admin-btn').classList.remove('hidden');
                        }
                    }
                }

            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', error.code);
                console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
                showError('–ü—Ä–æ—Ñ–∏–ª—å –∂“Ø–∫—Ç–µ–ª—É “õ–∞—Ç–µ—Å—ñ', error.message);
            }
        }

        async function loadCollections(uid) {
            try {
                console.log('  üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è:', uid);
                const collections = ['watching', 'favorite', 'completed', 'planned'];
                
                for (const type of collections) {
                    const q = query(collection(db, "collections"), where("userId", "==", uid), where("type", "==", type));
                    const snap = await getDocs(q);
                    document.getElementById(`count-${type}`).textContent = snap.size;
                    console.log(`  ‚úÖ ${type}: ${snap.size}`);
                }
            } catch (error) {
                console.error('  ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π:', error);
            }
        }

        async function loadComments(uid) {
            try {
                console.log('  üí¨ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è:', uid);
                const commentsQuery = query(
                    collection(db, "comments"), 
                    where("userId", "==", uid),
                    orderBy("time", "desc"),
                    limit(5)
                );
                const commentsSnap = await getDocs(commentsQuery);
                
                console.log(`  ‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${commentsSnap.size}`);
                document.getElementById('comments-count').textContent = commentsSnap.size;

                const commentsContainer = document.getElementById('recent-comments');
                commentsContainer.innerHTML = '';

                if (commentsSnap.empty) {
                    commentsContainer.innerHTML = '<p class="text-sm opacity-50 text-center py-4">–ü—ñ–∫—ñ—Ä–ª–µ—Ä –∂–æ“õ</p>';
                    return;
                }

                for (const commentDoc of commentsSnap.docs) {
                    const comment = commentDoc.data();
                    const animeDoc = await getDoc(doc(db, "content", comment.animeId));
                    const animeTitle = animeDoc.exists() ? animeDoc.data().title : '–ë–µ–ª–≥—ñ—Å—ñ–∑';
                    const date = new Date(comment.time).toLocaleDateString('kk-KZ');

                    commentsContainer.innerHTML += `
                    <div class="p-4 rounded-xl border border-zinc-800">
                        <div class="flex justify-between mb-2">
                            <span class="text-orange-500 text-xs font-bold">${escapeHtml(animeTitle)}</span>
                            <span class="opacity-40 text-[10px]">${date}</span>
                        </div>
                        <p class="text-sm opacity-80">${escapeHtml(comment.text)}</p>
                    </div>`;
                }
            } catch (error) {
                console.error('  ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
            }
        }

        async function loadRatings(uid) {
            try {
                console.log('  ‚≠ê –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏ –¥–ª—è:', uid);
                const ratingsQuery = query(collection(db, "ratings"), where("userId", "==", uid));
                const ratingsSnap = await getDocs(ratingsQuery);
                
                console.log(`  ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤: ${ratingsSnap.size}`);
                document.getElementById('ratings-count').textContent = ratingsSnap.size;

                let totalStars = 0;
                const ratingsContainer = document.getElementById('user-ratings');
                ratingsContainer.innerHTML = '';

                if (ratingsSnap.empty) {
                    ratingsContainer.innerHTML = '<p class="text-sm opacity-50 text-center py-4 col-span-full">–ë–∞“ì–∞–ª–∞—Ä –∂–æ“õ</p>';
                    return;
                }

                for (const ratingDoc of ratingsSnap.docs) {
                    const rating = ratingDoc.data();
                    totalStars += rating.stars || 0;

                    const animeDoc = await getDoc(doc(db, "content", rating.animeId));
                    if (animeDoc.exists()) {
                        const anime = animeDoc.data();
                        ratingsContainer.innerHTML += `
                        <div class="p-3 rounded-xl border border-zinc-800 text-center">
                            <img src="${anime.poster || '/placeholder.jpg'}" class="w-full h-32 object-cover rounded-lg mb-2" alt="${escapeHtml(anime.title)}" onerror="this.src='/placeholder.jpg'">
                            <p class="text-xs font-bold truncate">${escapeHtml(anime.title)}</p>
                            <div class="text-orange-500 font-bold mt-1">${rating.stars}/10</div>
                        </div>`;
                    }
                }

                const avgRating = ratingsSnap.size > 0 ? (totalStars / ratingsSnap.size).toFixed(1) : '0.0';
                document.getElementById('avg-rating').textContent = avgRating;
                console.log(`  ‚úÖ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ${avgRating}`);
            } catch (error) {
                console.error('  ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤:', error);
            }
        }

        async function loadFriends(uid) {
            try {
                console.log('  üë• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π –¥–ª—è:', uid);
                const friendsQuery = query(collection(db, "friends"), where("userId", "==", uid));
                const friendsSnap = await getDocs(friendsQuery);
                console.log(`  ‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π: ${friendsSnap.size}`);
                document.getElementById('friends-count').textContent = friendsSnap.size;
            } catch (error) {
                console.error('  ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error);
            }
        }

        async function loadActionButtons(viewedUserId, viewedUsername) {
            const buttonsDiv = document.getElementById('action-buttons');
            buttonsDiv.innerHTML = '';

            if (!auth.currentUser) {
                buttonsDiv.innerHTML = `<button onclick="location.href='index.html'" class="bg-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-700 text-white">–ö—ñ—Ä—É</button>`;
                return;
            }

            if (viewedUserId === auth.currentUser.uid) {
                buttonsDiv.innerHTML = `<button onclick="location.href='profile.html'" class="bg-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-700 text-white"><i class="fas fa-edit mr-2"></i>”®“£–¥–µ—É</button>`;
                return;
            }

            const friendStatus = await checkFriendship(viewedUserId);

            if (friendStatus === 'friends') {
                buttonsDiv.innerHTML = `
                    <button onclick="location.href='direct.html?friendId=${viewedUserId}'" class="bg-green-600 px-6 py-3 rounded-xl font-bold hover:bg-green-700 text-white">
                        <i class="fas fa-comment mr-2"></i>–ñ–∞–∑—É
                    </button>
                    <button onclick="removeFriend('${viewedUserId}')" class="bg-red-600 px-6 py-3 rounded-xl font-bold hover:bg-red-700 text-white">
                        <i class="fas fa-user-minus mr-2"></i>–î–æ—Å“õ–∞ –∞–ª–º–∞—É
                    </button>
                `;
            } else if (friendStatus === 'pending') {
                buttonsDiv.innerHTML = `<button class="bg-zinc-700 px-6 py-3 rounded-xl font-bold cursor-not-allowed text-white" disabled>
                    <i class="fas fa-clock mr-2"></i>–°“±—Ä–∞–Ω—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–≥–µ–Ω
                </button>`;
            } else if (friendStatus === 'incoming') {
                buttonsDiv.innerHTML = `<button onclick="location.href='profile.html'" class="bg-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-700 text-white">
                    <i class="fas fa-bell mr-2"></i>–°“±—Ä–∞–Ω—ã—Å—Ç—ã “õ–∞—Ä–∞“£—ã–∑
                </button>`;
            } else {
                buttonsDiv.innerHTML = `<button onclick="sendRequest('${viewedUserId}', '${escapeHtml(viewedUsername)}')" class="bg-orange-600 px-6 py-3 rounded-xl font-bold hover:bg-orange-700 text-white">
                    <i class="fas fa-user-plus mr-2"></i>–î–æ—Å“õ–∞ “õ–æ—Å—É
                </button>`;
            }
        }

        async function checkFriendship(friendId) {
            if (!auth.currentUser) return 'none';
            
            try {
                const q1 = query(collection(db, "friends"), where("userId", "==", auth.currentUser.uid), where("friendId", "==", friendId));
                const snap1 = await getDocs(q1);
                if (!snap1.empty) return 'friends';

                const q2 = query(collection(db, "friend_requests"), where("from", "==", auth.currentUser.uid), where("to", "==", friendId));
                const snap2 = await getDocs(q2);
                if (!snap2.empty) return 'pending';

                const q3 = query(collection(db, "friend_requests"), where("from", "==", friendId), where("to", "==", auth.currentUser.uid));
                const snap3 = await getDocs(q3);
                if (!snap3.empty) return 'incoming';

                return 'none';
            } catch (error) {
                console.error('  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∂–±—ã:', error);
                return 'none';
            }
        }

        window.sendRequest = async (toId, toUsername) => {
            if (!auth.currentUser) {
                showToast('–ö—ñ—Ä—ñ“£—ñ–∑!', 'error');
                return;
            }
            
            try {
                const existingQuery = query(collection(db, "friend_requests"), 
                    where("from", "==", auth.currentUser.uid),
                    where("to", "==", toId));
                const existingSnap = await getDocs(existingQuery);
                
                if (!existingSnap.empty) {
                    showToast('–°“±—Ä–∞–Ω—ã—Å –±“±—Ä—ã–Ω –∂—ñ–±–µ—Ä—ñ–ª–≥–µ–Ω!', 'error');
                    return;
                }
                
                const myDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                if (!myDoc.exists()) {
                    showToast('“ö–∞—Ç–µ: –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã!', 'error');
                    return;
                }
                
                await addDoc(collection(db, "friend_requests"), {
                    from: auth.currentUser.uid,
                    fromUsername: myDoc.data().username,
                    to: toId,
                    toUsername: toUsername,
                    time: Date.now()
                });
                
                showToast('–°“±—Ä–∞–Ω—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!', 'success');
                await loadActionButtons(toId, toUsername);
            } catch(e) {
                console.error('Friend request error:', e);
                showToast('“ö–∞—Ç–µ: ' + e.message, 'error');
            }
        };

        window.removeFriend = async (friendId) => {
            if (!confirm('–î–æ—Å—Ç—ã ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?')) return;
            
            try {
                const q1 = query(collection(db, "friends"), where("userId", "==", auth.currentUser.uid), where("friendId", "==", friendId));
                const snap1 = await getDocs(q1);
                for (const docSnapshot of snap1.docs) {
                    await deleteDoc(docSnapshot.ref);
                }

                const q2 = query(collection(db, "friends"), where("userId", "==", friendId), where("friendId", "==", auth.currentUser.uid));
                const snap2 = await getDocs(q2);
                for (const docSnapshot of snap2.docs) {
                    await deleteDoc(docSnapshot.ref);
                }

                showToast('–î–æ—Å ”©—à—ñ—Ä—ñ–ª–¥—ñ', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch(e) {
                console.error('Remove friend error:', e);
                showToast('“ö–∞—Ç–µ –±–æ–ª–¥—ã!', 'error');
            }
        };

        // –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        onAuthStateChanged(auth, async (user) => {
            console.log('üîê Auth state changed:', user ? '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' : '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            await loadUserProfile();
        });
    </script>
</body>
</html>
